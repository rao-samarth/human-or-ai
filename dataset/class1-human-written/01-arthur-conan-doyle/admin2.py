# Generated by Claude, for administrative tasks related to Arthur Conan Doyle dataset.

#!/usr/bin/env python3
"""
Script to extract 20 random paragraphs (100-200 words) from each book in selected-books
and save them to extracted_paragraphs directory.
"""

import os
import random
from pathlib import Path


def count_words_in_paragraph(paragraph):
    """Count the number of words in a paragraph."""
    return len(paragraph.split())


def extract_paragraphs_from_book(filepath, min_words=100, max_words=200):
    """
    Extract paragraphs that meet word count criteria from a book file.
    
    Args:
        filepath: Path to the book file
        min_words: Minimum word count (default: 100)
        max_words: Maximum word count (default: 200)
    
    Returns:
        list: List of paragraphs that meet the word count criteria
    """
    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()
    
    # Split by double newlines to get paragraphs
    paragraphs = content.split('\n\n')
    
    # Filter paragraphs that meet the word count criteria
    valid_paragraphs = []
    for paragraph in paragraphs:
        paragraph = paragraph.strip()
        if paragraph:
            word_count = count_words_in_paragraph(paragraph)
            if min_words <= word_count <= max_words:
                valid_paragraphs.append(paragraph)
    
    return valid_paragraphs


def process_book(book_path, output_dir):
    """
    Process a single book: extract valid paragraphs and save 20 random ones.
    
    Args:
        book_path: Path to the book file
        output_dir: Directory where extracted paragraphs should be saved
    """
    print(f"Processing: {book_path.name}")
    
    # First try to extract paragraphs with 100-200 words
    valid_paragraphs = extract_paragraphs_from_book(book_path, min_words=100, max_words=200)
    
    word_range = "100-200"
    
    # If we don't have enough paragraphs, extend the range to 85-215 words
    if len(valid_paragraphs) < 20:
        print(f"  Only found {len(valid_paragraphs)} paragraphs (100-200 words)")
        print(f"  Extending range to 85-215 words...")
        valid_paragraphs = extract_paragraphs_from_book(book_path, min_words=85, max_words=215)
        word_range = "85-215"
    
    if len(valid_paragraphs) < 20:
        print(f"  WARNING: Only found {len(valid_paragraphs)} valid paragraphs even with extended range (need 20)")
        print(f"  Skipping {book_path.name}")
        return
    
    print(f"  Found {len(valid_paragraphs)} valid paragraphs ({word_range} words)")
    
    # Randomly select 20 paragraphs
    selected_paragraphs = random.sample(valid_paragraphs, 20)
    
    # Get the book's base name (without extension)
    # e.g., "001_Study_in_Scarlet.txt" -> "001_Study_in_Scarlet"
    book_basename = book_path.stem
    
    # Save each paragraph to a separate file
    for i, paragraph in enumerate(selected_paragraphs, start=1):
        output_filename = f"{book_basename}_{i:02d}.txt"
        output_path = output_dir / output_filename
        
        with open(output_path, 'w', encoding='utf-8') as f:
            f.write(paragraph)
    
    print(f"  Saved 20 paragraphs to extracted_paragraphs/")


def main():
    """Main function to process all books in selected-books directory."""
    # Get the directory where this script is located
    script_dir = Path(__file__).parent
    
    # Define directories
    selected_books_dir = script_dir / 'selected-books'
    extracted_paragraphs_dir = script_dir / 'extracted_paragraphs'
    
    # Check if directories exist
    if not selected_books_dir.exists():
        print(f"ERROR: Directory not found: {selected_books_dir}")
        return
    
    if not extracted_paragraphs_dir.exists():
        print(f"Creating directory: {extracted_paragraphs_dir}")
        extracted_paragraphs_dir.mkdir(parents=True)
    
    # Get all .txt files in selected-books
    book_files = sorted([f for f in selected_books_dir.glob('*.txt') if f.is_file()])
    
    if not book_files:
        print(f"No .txt files found in {selected_books_dir}")
        return
    
    print(f"Found {len(book_files)} book files in selected-books/")
    print(f"Processing each book to extract 20 random paragraphs (100-200 words)...\n")
    
    # Set random seed for reproducibility (optional - remove if you want different results each time)
    random.seed(42)
    
    # Process each book
    success_count = 0
    for book_file in book_files:
        try:
            process_book(book_file, extracted_paragraphs_dir)
            success_count += 1
        except Exception as e:
            print(f"  ERROR processing {book_file.name}: {e}")
            import traceback
            traceback.print_exc()
    
    print(f"\n{'='*60}")
    print(f"Processing complete!")
    print(f"Successfully processed: {success_count}/{len(book_files)} books")
    print(f"Output directory: {extracted_paragraphs_dir}")


if __name__ == '__main__':
    main()
